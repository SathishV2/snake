<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberpunk Snake</title>
    <!-- Load Tailwind CSS for responsive utilities and base styling --><script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Global Styles for Cyberpunk Aesthetic */
        body {
            font-family: 'Inter', monospace, sans-serif;
            background-color: #0d0d18; /* Very dark blue-purple base */
            color: #33ff33; /* Neon Green text */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: auto; /* Allow scrolling for tall canvas */
        }

        /* Game Area/Canvas Styling */
        #game-container {
            position: relative;
            background-color: #000000;
            border: 4px solid #33ff33; /* Neon Green border */
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.8), 0 0 5px rgba(51, 255, 51, 0.5) inset; /* Outer glow */
            border-radius: 8px;
            overflow: hidden;
            /* Dimensions are fixed by JS */
        }

        #gameCanvas {
            display: block;
            background-color: #000000;
            /* Subtle scanline effect for retro feel */
            background-image: linear-gradient(rgba(0, 0, 0, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                              linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 4px, 4px 100%;
        }

        /* Control Button & Message Box Styling (retained) */
        .ctrl-btn {
            background-color: #1a1a2e;
            color: #00FFFF;
            border: 2px solid #00FFFF;
            border-radius: 12px;
            padding: 1rem 2rem;
            font-weight: bold;
            font-size: 1.25rem;
            /* Ensure smooth transitions in WebKit/Chrome */
            -webkit-transition: all 0.15s ease-in-out;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.5);
            -webkit-tap-highlight-color: transparent;
        }

        .ctrl-btn:active {
            background-color: #00FFFF;
            color: #1a1a2e;
            box-shadow: 0 0 15px rgba(0, 255, 255, 1);
            /* Ensure transform scales correctly in WebKit/Chrome */
            -webkit-transform: scale(0.95);
            transform: scale(0.95);
        }

        #message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            /* Ensure transform translates correctly in WebKit/Chrome */
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #FF00FF;
            box-shadow: 0 0 20px rgba(255, 0, 255, 1);
            padding: 2.5rem;
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            display: none;
            color: #FF00FF;
        }

        #message-box h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            text-shadow: 0 0 5px #FF00FF;
            display: flex; /* Allow content to be on the same line */
            justify-content: center;
            align-items: center;
            gap: 10px; /* Space between symbol and text */
        }
        
        #message-box p {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            color: #33ff33;
        }
        
        /* --- JOYSTICK STYLING --- */
        #joystick-base {
            width: 150px;
            height: 150px;
            background-color: rgba(51, 255, 51, 0.1); /* Subtle neon base */
            border: 3px solid #33ff33;
            border-radius: 50%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 15px rgba(51, 255, 51, 0.4);
            touch-action: none; /* Critical for touch events */
        }

        #joystick-thumb {
            width: 50px;
            height: 50px;
            background-color: #00FFFF; /* Electric Blue thumb */
            border: 3px solid #000000;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            /* Vendor prefixes for transform/translate on Chrome */
            -webkit-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.8), inset 0 0 5px #FFFFFF;
            /* Vendor prefixes for smooth transition on Chrome */
            -webkit-transition: -webkit-transform 0.05s linear;
            transition: transform 0.05s linear; 
        }
    </style>
</head>
<body>

    <div id="game-wrapper" class="p-4 flex flex-col items-center gap-4">

        <h1 class="text-3xl font-extrabold tracking-widest text-shadow-lg" style="text-shadow: 0 0 5px #33ff33; color: #33ff33;">
            <span style="color: #FF0000; text-shadow: 0 0 5px #FF0000;">üêç</span> SNAKE
        </h1>

        <div id="game-container" class="flex-shrink-0">
            <canvas id="gameCanvas"></canvas>
            <div id="message-box">
                <h2 id="message-title"></h2>
                <p id="message-score">Score: 0</p>
                
                <!-- Removed High Score Input Section -->
                
                <!-- Regular Restart Button -->
                <button id="restartButton" class="ctrl-btn mx-auto mt-4" style="color: #33ff33; border-color: #33ff33;">
                    RESTART
                </button>
            </div>
        </div>

        <!-- Scoreboard and Controls -->
        <div class="w-full max-w-sm flex flex-col gap-3">
            <!-- Removed User ID display -->
            <div class="flex justify-around text-lg font-bold">
                <p>SCORE: <span id="score" class="text-3xl text-white tracking-wider" style="text-shadow: 0 0 5px #00FFFF;">0</span></p>
                <!-- High Score simplified to just the value, as name saving is removed -->
                <p>
                    HIGH: 
                    <span id="highScoreName" class="text-xs text-yellow-400 tracking-wider" style="text-shadow: 0 0 3px #FFFF00;">LOCAL</span>
                    <span id="highScore" class="text-3xl text-white tracking-wider" style="text-shadow: 0 0 5px #FF00FF;">0</span>
                </p>
            </div>

            <!-- Mobile Controls: Virtual Joystick -->
            <div id="joystick-container" class="sm:hidden flex justify-center mt-4">
                <div id="joystick-base">
                    <div id="joystick-thumb"></div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Removed all Firebase imports

        document.addEventListener('DOMContentLoaded', () => {
            // Removed setLogLevel('Debug');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = document.getElementById('score');
            const highScoreDisplay = document.getElementById('highScore');
            const highScoreNameDisplay = document.getElementById('highScoreName'); 
            // Removed userIdDisplay
            const messageBox = document.getElementById('message-box');
            const messageTitle = document.getElementById('message-title');
            const messageScore = document.getElementById('message-score');
            const restartButton = document.getElementById('restartButton');
            
            // Removed New High Score UI Elements (input, submit button)
            
            // Joystick Elements
            const joystickBase = document.getElementById('joystick-base');
            const joystickThumb = document.getElementById('joystick-thumb');

            // --- Game Variables ---
            // FIXED DIMENSIONS: 20 tiles wide, 27 tiles high (400px x 540px)
            const TILE_SIZE = 20;
            const TILE_COUNT_W = 20; 
            const TILE_COUNT_H = 27; 
            let gridWidth = TILE_COUNT_W;
            let gridHeight = TILE_COUNT_H;
            
            const GAME_SPEED = 100; // ms per update
            let intervalId = null;
            let snake = [];
            let food = null; // Regular (Blue) food position
            
            // --- TIMER VARIABLES (Now applied to regular food) ---
            const BONUS_SPAWN_THRESHOLD = 10; 
            const FOOD_TIME_LIMIT = 5000; // 5 seconds
            let foodsEaten = 0;             
            let bonusFood = null;           // Bonus (Yellow) food position (no timer)
            let foodTimerId = null;         // Timer ID for regular food
            let foodStartTime = 0;          // Time when regular food spawned
            // --- END TIMER VARIABLES ---
            
            let dx = 0; // Direction X
            let dy = 0; // Direction Y
            let score = 0;
            let isPaused = true;
            let changingDirection = false;
            let highScore = 0;
            // The name is now fixed to LOCAL
            let highScoreName = "LOCAL"; 
            let gameInitialized = false; 

            // --- Joystick Variables ---
            const JOYSTICK_RADIUS = 75; // Half of the base width (150px)
            let isDragging = false;


            // --- Local Storage High Score Logic ---
            const HIGH_SCORE_KEY = 'cyberpunk_snake_high_score';

            function loadHighScore() {
                try {
                    const localScore = localStorage.getItem(HIGH_SCORE_KEY);
                    highScore = localScore ? parseInt(localScore, 10) : 0;
                } catch (e) {
                    console.error("Error loading local storage:", e);
                    highScore = 0;
                }
                highScoreDisplay.textContent = highScore;
                highScoreNameDisplay.textContent = highScoreName;
            }

            function updateHighScore() {
                if (score > highScore) {
                    highScore = score;
                    highScoreDisplay.textContent = highScore;
                    try {
                        localStorage.setItem(HIGH_SCORE_KEY, score.toString());
                    } catch (e) {
                        console.error("Error saving to local storage:", e);
                    }
                }
            }
            // Removed startHighScoreListener and submitNameAndSaveScore functions


            // --- Initialization ---

            function resizeCanvas() {
                // Set canvas width to 20 tiles * 20px = 400px
                const width = TILE_COUNT_W * TILE_SIZE; 
                // Set canvas height to 27 tiles * 20px = 540px
                const height = TILE_COUNT_H * TILE_SIZE; 

                canvas.width = width;
                canvas.height = height;

                // Set container size
                const container = document.getElementById('game-container');
                container.style.width = `${width}px`;
                container.style.height = `${height}px`;
                container.style.maxWidth = `${width}px`; 
                container.style.maxHeight = `${height}px`; 
            }

            
            function clearFoodTimer() {
                if (foodTimerId) {
                    clearTimeout(foodTimerId);
                    foodTimerId = null;
                }
            }

            function initGame() {
                if (gameInitialized) {
                    // Only load score if we are restarting after a failure, not on first load
                    loadHighScore(); 
                } else {
                    // Load score on first initialization
                    loadHighScore();
                    gameInitialized = true;
                }
                
                resizeCanvas();
                
                // Hide high score input (now removed from HTML)
                restartButton.style.display = 'block';

                // Initial position near the center of the new 20x27 grid
                snake = [
                    { x: Math.floor(gridWidth / 2), y: Math.floor(gridHeight / 2) },
                    { x: Math.floor(gridWidth / 2) - 1, y: Math.floor(gridHeight / 2) },
                    { x: Math.floor(gridWidth / 2) - 2, y: Math.floor(gridHeight / 2) }
                ];
                dx = 1;
                dy = 0;
                score = 0; // Score reset confirmed
                foodsEaten = 0; 
                food = null;
                bonusFood = null; 
                clearFoodTimer(); // Clear timer on init
                scoreDisplay.textContent = score;
                isPaused = true;
                
                // Initial message with red snake icon and "SNAKE"
                messageTitle.innerHTML = `<span style="color: #FF0000; text-shadow: 0 0 5px #FF0000;">üêç</span> SNAKE`;
                messageScore.textContent = 'Drag the joystick or use Arrow Keys/WASD to begin.';
                restartButton.textContent = 'START';
                messageBox.style.display = 'block';

                generateFood();
                draw();
            }

            function startGame() {
                if (isPaused) {
                    isPaused = false;
                    messageBox.style.display = 'none';
                    if (intervalId) clearInterval(intervalId);
                    intervalId = setInterval(gameLoop, GAME_SPEED);
                }
            }

            // --- Drawing Functions ---

            function drawRect(x, y, color) {
                ctx.fillStyle = color;
                ctx.shadowColor = color;
                ctx.shadowBlur = 5; 
                ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                ctx.shadowBlur = 0; 
            }

            function drawSnake() {
                snake.forEach((segment, index) => {
                    const color = index === 0 ? '#66FF66' : '#33FF33'; 
                    drawRect(segment.x, segment.y, color);
                });
            }

            function drawFood() {
                // Regular Food (Electric Cyan) - Now with Timer
                if (food) {
                    drawRect(food.x, food.y, '#00FFFF');
                    // Draw a small central highlight
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(food.x * TILE_SIZE + TILE_SIZE / 4, food.y * TILE_SIZE + TILE_SIZE / 4, TILE_SIZE / 2, TILE_SIZE / 2);

                    // --- DRAW TIMER (Improved Visibility) ---
                    const timeRemaining = Math.max(0, FOOD_TIME_LIMIT - (Date.now() - foodStartTime));
                    // Check if time is running low for visual warning
                    const isLowTime = timeRemaining < 2000; 
                    const seconds = (timeRemaining / 1000).toFixed(1);
                    const textX = food.x * TILE_SIZE + TILE_SIZE / 2;
                    const textY = food.y * TILE_SIZE - 5;
                    const textWidth = 35; 

                    // 1. Draw high-contrast background box (Magenta/Red based on time)
                    ctx.fillStyle = isLowTime ? '#FF0000' : '#FF00FF'; 
                    ctx.fillRect(textX - textWidth / 2 - 2, textY - 14, textWidth + 4, 18);
                    
                    // 2. Draw text (White/Cyan with shadow)
                    ctx.fillStyle = '#FFFFFF'; 
                    ctx.shadowColor = isLowTime ? '#FFFFFF' : '#00FFFF';
                    ctx.shadowBlur = 3;
                    ctx.font = 'bold 16px Inter, monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(`${seconds}s`, textX, textY);
                    ctx.shadowBlur = 0; 
                }
                
                // Bonus Food (Yellow Neon) - No Timer
                if (bonusFood) {
                    // Use a slightly different draw style for bonus to emphasize it
                    ctx.fillStyle = '#FFFF00'; // Neon Yellow
                    ctx.shadowColor = '#FFFF00';
                    ctx.shadowBlur = 10; // Extra glow
                    ctx.fillRect(bonusFood.x * TILE_SIZE, bonusFood.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                    ctx.shadowBlur = 0; 
                    
                    // Draw a pulsating effect (simulated with a slight white square)
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.fillRect(bonusFood.x * TILE_SIZE + TILE_SIZE / 3, bonusFood.y * TILE_SIZE + TILE_SIZE / 3, TILE_SIZE / 3, TILE_SIZE / 3);
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                drawFood();
                drawSnake();
            }

            // --- Game Logic ---
            
            function getNewFoodPosition() {
                let newPos;
                let isOverlap;
                do {
                    newPos = {
                        // Use gridWidth (20) for X generation
                        x: Math.floor(Math.random() * gridWidth),
                        // Use gridHeight (27) for Y generation
                        y: Math.floor(Math.random() * gridHeight)
                    };
                    // Check overlap with snake
                    isOverlap = snake.some(segment => segment.x === newPos.x && segment.y === newPos.y);
                    // Check overlap between food types
                    if (!isOverlap && food && newPos.x === food.x && newPos.y === food.y) {
                         isOverlap = true;
                    }
                    if (!isOverlap && bonusFood && newPos.x === bonusFood.x && newPos.y === bonusFood.y) {
                         isOverlap = true;
                    }

                } while (isOverlap);
                return newPos;
            }
            
            function startFoodTimer() {
                clearFoodTimer();
                foodStartTime = Date.now();
                
                foodTimerId = setTimeout(() => {
                    // This triggers if the regular food timer runs out
                    if (food) {
                        console.log("Regular food timer ran out. Game Over.");
                        gameOver(true); // Game Over on time failure
                    }
                }, FOOD_TIME_LIMIT);
            }

            function generateFood() {
                // 1. If foodsEaten hits threshold AND bonus isn't already spawned, spawn bonus (NO TIMER)
                if (foodsEaten > 0 && foodsEaten % BONUS_SPAWN_THRESHOLD === 0 && bonusFood === null) {
                    bonusFood = getNewFoodPosition();
                }

                // 2. Ensure regular food is always present if no regular food exists (START TIMER)
                if (food === null) {
                    food = getNewFoodPosition();
                    startFoodTimer(); 
                }
            }

            function moveSnake() {
                let newX = snake[0].x + dx;
                let newY = snake[0].y + dy;

                // WALL WRAPPING LOGIC - Now respects the different width (20) and height (27)
                if (newX < 0) {
                    newX = gridWidth - 1; 
                } else if (newX >= gridWidth) {
                    newX = 0;
                }
                
                if (newY < 0) {
                    newY = gridHeight - 1; 
                } else if (newY >= gridHeight) {
                    newY = 0;
                }

                